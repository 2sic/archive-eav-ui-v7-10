!function(){"use strict";function e(){var e,t,i=arguments[0];for(t=1;t<arguments.length;t++)for(e in arguments[t])arguments[t].hasOwnProperty(e)&&(i[e]=arguments[t][e]);return i}function t(e){return e+(new Date).getTime()+"-"+Math.floor(1e13*Math.random())}function i(i,n){this.uri=i,this.config=e({},this.constructor.defaultConfig,n),this.config.windowName=this.config.windowName||t("promise-window-"),this._onPostMessage=this._onPostMessage.bind(this)}var n,r=window,o=r.document.documentElement;i.getAPlusPromiseProvider=function(e){return function(){var t={};return t.promise=new e(function(e,i){t.resolve=e,t.reject=i}),t}},i.open=function(e,t){return new i(e,t).open()},i.defaultConfig={width:o.clientWidth,height:o.clientHeight,watcherDelay:100,promiseProvider:null,onPostMessage:function(e){e.data.error?this._reject(e.data.error):this._resolve(e.data),this.close()},windowName:null},i.defaultConfig.promiseProvider=r.Promise?i.getAPlusPromiseProvider(r.Promise):r.RSVP?i.getAPlusPromiseProvider(r.RSVP.Promise):r.Q?i.getAPlusPromiseProvider(r.Q.Promise):r.jQuery?function(){var e=r.jQuery.Deferred();return{promise:e.promise(),resolve:e.resolve,reject:e.reject}}:function(){throw new Error("Missing promiseProvider in PromiseWindow configuration")},n=i.prototype,n._getFeatures=function(){var e=this.config.width,t=this.config.height,i=void 0!==r.screenLeft?r.screenLeft:screen.left,n=void 0!==r.screenTop?r.screenTop:screen.top,s=r.innerWidth||o.clientWidth||screen.width,h=r.innerHeight||o.clientHeight||screen.height,c=s/2-e/2+i,a=h/2-t/2+n;return"scrollbars=yes, width="+e+", height="+t+", top="+a+", left="+c},n._createPromise=function(){var e=this.config.promiseProvider();return this._resolve=e.resolve,this._reject=e.reject,e.promise},n._isWindowAlive=function(){return this._window&&!this._window.closed},n._startWatcher=function(){if(this._watcherRunning)throw new Error("Watcher is already started");this._watcher=r.setInterval(function(){this._watcherRunning&&!this._isWindowAlive()&&this.close()}.bind(this),this.config.watcherDelay),this._watcherRunning=!0},n._stopWatcher=function(){if(!this._watcherRunning)throw new Error("Watcher is already stopped");this._watcherRunning=!1,r.clearInterval(this._watcher)},n._onPostMessage=function(e){this._window===e.source&&this.config.onPostMessage.call(this,e)},n.setURI=function(e){if(this.isOpen())throw new Error("Cannot change the URI while the window is open");return this.uri=e,this},n.open=function(){if(this.isOpen())throw new Error("Window is already open");this._windowOpen=!0;var e=this._createPromise();return this._window=r.open(this.uri,this.config.windowName,this._getFeatures()),this._window?(r.addEventListener("message",this._onPostMessage,!0),this._startWatcher()):this._reject("blocked"),e},n.close=function(){if(!this.isOpen())throw new Error("Window is already closed");this._stopWatcher(),r.removeEventListener("message",this._onPostMessage),this._isWindowAlive()&&(this._window.onclose=null,this._window.close()),this._reject("closed"),this._window=null,this._windowOpen=!1},n.isOpen=function(){return this._windowOpen},"function"==typeof define&&define.amd?define("promise-window",[],function(){return i}):"object"==typeof exports?module.exports=i:r.PromiseWindow=i}();