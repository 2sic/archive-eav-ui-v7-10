!function(){"use strict";function e(){var e,i,t=arguments[0];for(i=1;i<arguments.length;i++)for(e in arguments[i])arguments[i].hasOwnProperty(e)&&(t[e]=arguments[i][e]);return t}function i(e){return e+(new Date).getTime()+"-"+Math.floor(1e13*Math.random())}function t(t,n){this.uri=t,this.config=e({},this.constructor.defaultConfig,n),this.config.windowName=this.config.windowName||i("promise-window-"),this._onPostMessage=this._onPostMessage.bind(this)}var n,r=window,o=r.document.documentElement;t.getAPlusPromiseProvider=function(e){return function(){var i={};return i.promise=new e(function(e,t){i.resolve=e,i.reject=t}),i}},t.open=function(e,i){return new t(e,i).open()},t.defaultConfig={width:o.clientWidth,height:o.clientHeight,window:{scrollbars:!0},watcherDelay:100,promiseProvider:null,onPostMessage:function(e){e.data.error?this._reject(e.data.error):this._resolve(e.data),this.close()},windowName:null},r.Promise?t.defaultConfig.promiseProvider=t.getAPlusPromiseProvider(r.Promise):r.RSVP?t.defaultConfig.promiseProvider=t.getAPlusPromiseProvider(r.RSVP.Promise):r.Q?t.defaultConfig.promiseProvider=t.getAPlusPromiseProvider(r.Q.Promise):r.jQuery?t.defaultConfig.promiseProvider=function(){var e=r.jQuery.Deferred();return{promise:e.promise(),resolve:e.resolve,reject:e.reject}}:t.defaultConfig.promiseProvider=function(){throw new Error("Missing promiseProvider in PromiseWindow configuration")},n=t.prototype,n._isBoolean=function(e){return e===!0||e===!1},n._serializeFeatureValue=function(e,i){return this._isBoolean(i)?i?"yes":"no":""+i},n._getCenteredPosition=function(e,i){var t=void 0!==r.screenLeft?r.screenLeft:screen.left,n=void 0!==r.screenTop?r.screenTop:screen.top,s=r.innerWidth||o.clientWidth||screen.width,h=r.innerHeight||o.clientHeight||screen.height;return{left:s/2-e/2+t,top:h/2-i/2+n,width:e,height:i}},n._getFeatures=function(){var e=this._getCenteredPosition(this.config.width,this.config.height);for(var i in this.config.window)this.config.window.hasOwnProperty(i)&&(e[i]=this.config.window[i]);return Object.keys(e).map(function(i){return i+"="+this._serializeFeatureValue(i,e[i])}.bind(this)).join(",")},n._createPromise=function(){var e=this.config.promiseProvider();return this._resolve=e.resolve,this._reject=e.reject,e.promise},n._isWindowAlive=function(){return this._window&&!this._window.closed},n._startWatcher=function(){if(this._watcherRunning)throw new Error("Watcher is already started");this._watcher=r.setInterval(function(){this._watcherRunning&&!this._isWindowAlive()&&this.close()}.bind(this),this.config.watcherDelay),this._watcherRunning=!0},n._stopWatcher=function(){if(!this._watcherRunning)throw new Error("Watcher is already stopped");this._watcherRunning=!1,r.clearInterval(this._watcher)},n._onPostMessage=function(e){this._window===e.source&&this.config.onPostMessage.call(this,e)},n.setURI=function(e){if(this.isOpen())throw new Error("Cannot change the URI while the window is open");return this.uri=e,this},n.open=function(){if(this.isOpen())throw new Error("Window is already open");this._windowOpen=!0;var e=this._createPromise();return this._window=r.open(this.uri,this.config.windowName,this._getFeatures()),this._window?(r.addEventListener("message",this._onPostMessage,!0),this._startWatcher()):this._reject("blocked"),e},n.close=function(){if(!this.isOpen())throw new Error("Window is already closed");this._stopWatcher(),r.removeEventListener("message",this._onPostMessage),this._isWindowAlive()&&(this._window.onclose=null,this._window.close()),this._reject("closed"),this._window=null,this._windowOpen=!1},n.isOpen=function(){return this._windowOpen},"function"==typeof define&&define.amd?define("promise-window",[],function(){return t}):"object"==typeof exports?module.exports=t:r.PromiseWindow=t}();